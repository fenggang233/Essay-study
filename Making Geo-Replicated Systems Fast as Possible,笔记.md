## making geo-replicated systems fast and consistent

1. 红蓝一致性：蓝色操作速度快且最终实现跨地理位置一致，红色操作保存强一致性但速度慢
2. 确定了何时操作可以是蓝色且必须为红色的条件
3. 找到一种通过将潜在的蓝色操作分成单独的生成器阶段和阴影阶段来增加它们的空间的方法。只有阴影阶段的操作被涂红色或者蓝色，这样的分类有助于对操作进行细粒度的分类。

红蓝一致性在牺牲了部分一致性的前提下提供了巨大的性能增益

一个优秀的解决方案应该有的特质：低延迟，所有执行了相同操作集的副本都处于相同的状态，应该避免与传统的单服务器语义明显不同，系统要遵循系统规范，某个副本系统上的操作最终要传播到所有的其他副本系统上。

我们允许不同的操作符合不同的一致性级别。通过定义一系列的条件来精确判断每一个操作所适合的一致性级别。我们根据操作的动作和所需的系统语义系统地划分操作空间。对于每一个操作，我们都可能根据执行细节的不同生成不同的阴影操作，且它们可以在不同的一致性级别下执行。

RedBlue一致性基于将操作明确划分为红蓝操作，蓝色操作的执行顺序因站点而异，并且红色操作必须在所有站点上以相同的顺序执行

定义1：（红蓝序）
一组被分为红蓝两组的操作集，其中每种操作只能是红色或蓝色，一个红蓝序包含操作集和一个偏序关系，任两个红色操作有确定的偏序关系。
若一组站点中所有站点从初始状态开始（默认初始状态相同），执行相同红蓝序的操作序列，那么分布式系统就是红蓝一致的。

蓝色操作可以有和其他操作的偏序关系也可以没有。

定义2：（因果序列化）给定一个站点，当满足下列两个条件时，称i上的红蓝序Oi(U,<)它是相对于红蓝序O(U,<<)因果序列化的.
1. Oi是O的线性延拓（Oi满足O中的所有偏序关系并可能更多）
2. 对于任意两个操作u,v，如果site(u)=i(最开始的时候操作u是应用在站点i上的)且在Oi有u<v，则O中必有u<<v

定义3：（红蓝一致性）一个多站点的复制系统具有红蓝一致性是指每个站点i按照一个按照一个特定的序列执行操作，且所有站点的操作序列是一个共同的红蓝序O的因果序列化序列。

当操作集中所有操作都是红色时，红蓝一致性就是强一致性，要求所有站点执行完全相同的操作序列

定义4：（状态收敛）若一个红蓝一致性系统在所有站点的按照其满足红蓝序的指令序列执行后处于相同状态，则它是状态收敛的。

定理1 一个红蓝一致性系统是状态收敛的充分条件是操作集中所有的蓝色操作与任一其他操作都是可交换顺序执行的。

按照理论，需要把每一个应用操作分成两部分：生成器操作：无副作用，只在初始站点执行，生成阴影操作。阴影操作：在每个站点执行。
其中，生成器操作决定应该进行怎样的状态转换而阴影操作以状态无关的方式在所有站点上应用这个操作。

定义5：（正确的生成器/阴影操作）若对于所有的状态S，生成器操作gu都不对状态产生任何影响（不使S发生转移），而根据当前状态S和待分解操作u生成的阴影操作hu(S)作用在状态S上和u作用在S上效果相同时，认为操作u的分解是正确的。

定义6：（因果序列化-修订版）给定站点i，若Oi=(U+Vi,<)是红蓝序O(U,<<)的一个站点i的因果序列化，则它要满足：
1. Oi中的操作是全排序的
2. (U,<)是O的线性延拓
3. 对于U中的任意hv(S)（阴影操作），且该阴影操作由Vi中的生成器操作gv生成，S是由Oi中所有gv之前的阴影操作作用在站点i的初始状态S0之后得到的状态。
4. 对任意的生成器操作gv和阴影操作hu(S)（说明该阴影操作由生成器操作gu生成），Oi中存在hu(S)<gv当且仅当O中有hu(S)<<hv(S')
要注意：阴影操作会出现在所有站点的因果序列中，而生成器操作只出现在初始站点的因果序列中。

定义7：（不变量安全性）若对于的有效状态S,S',S'+hu(S)总是有效的，则阴影操作hu(S)是不变量安全的。

（所以hu(S)的含义不是这个操作只能作用在S状态咯？）

定理2：若所有的阴影操作都是正确的且所有标记为蓝色的阴影操作都是保持不变量安全且全局可交换的，那么对于满足红蓝一致性的系统中的任何操作，任何站点在任何时刻都不会处于一个无效的状态。

综合定理1和定理2我们可以得到如何判断一个操作如何着色：
1. 若存在两个操作u,v不可交换，就把它们俩都标上红色
2. 对于任意一个可能使系统状态进入无效状态的操作，标红
3. 剩下的都标蓝

